<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Detection - Advanced OCR System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .field-detection-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .upload-zone {
            border: 3px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-zone:hover {
            border-color: #0056b3;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            transform: translateY(-2px);
        }
        
        .upload-zone.drag-over {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .text-input-area {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .confidence-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .field-card {
            border-left: 4px solid #007bff;
            margin: 10px 0;
            transition: transform 0.2s;
        }
        
        .field-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .confidence-badge {
            font-size: 0.9em;
            padding: 0.4em 0.8em;
            border-radius: 20px;
        }
        
        .confidence-high { background-color: #d4edda; color: #155724; }
        .confidence-medium { background-color: #fff3cd; color: #856404; }
        .confidence-low { background-color: #f8d7da; color: #721c24; }
        
        .validation-status {
            padding: 0.3em 0.6em;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .validation-valid { background-color: #d4edda; color: #155724; }
        .validation-invalid { background-color: #f8d7da; color: #721c24; }
        .validation-uncertain { background-color: #fff3cd; color: #856404; }
        
        .category-section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .processing-indicator {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .results-section {
            margin-top: 30px;
            display: none;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .method-badge {
            padding: 0.2em 0.5em;
            border-radius: 10px;
            font-size: 0.75em;
            margin-right: 5px;
        }
        
        .method-ml { background-color: #007bff; color: white; }
        .method-rag { background-color: #28a745; color: white; }
        .method-pattern { background-color: #ffc107; color: black; }
        .method-hybrid { background-color: #6f42c1; color: white; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot me-2"></i>Advanced OCR System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/document_processing"><i class="fas fa-file-alt me-1"></i>Document Processing</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/field_detection"><i class="fas fa-search-plus me-1"></i>Field Detection</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="field-detection-container">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-4">
                    <h1 class="display-5 fw-bold text-primary">
                        <i class="fas fa-search-plus me-3"></i>Field Detection System
                    </h1>
                    <p class="lead text-muted">
                        Advanced AI-powered field extraction from documents and OCR text
                    </p>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-upload me-2"></i>Upload Document Image
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="uploadZone" class="upload-zone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>Drop your document here or click to browse</h5>
                            <p class="text-muted">Supports JPG, PNG, PDF formats</p>
                            <input type="file" id="fileInput" class="d-none" accept="image/*,.pdf">
                        </div>
                        <div class="mt-3">
                            <label for="confidenceSlider" class="form-label">
                                Confidence Threshold: <span id="confidenceValue">0.5</span>
                            </label>
                            <input type="range" class="form-range" min="0.1" max="1.0" step="0.1" 
                                   value="0.5" id="confidenceSlider">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-keyboard me-2"></i>Or Enter OCR Text
                        </h5>
                    </div>
                    <div class="card-body">
                        <textarea id="textInput" class="form-control text-input-area" 
                                  placeholder="Paste your OCR text here for field detection...

Example:
Name: RAJESH KUMAR
S/O: RAM PRASAD
DOB: 15/08/1990
Aadhar: 1234 5678 9012
Mobile: +91 9876543210
PAN: ABCDE1234F"></textarea>
                        <div class="mt-3">
                            <button id="detectFromTextBtn" class="btn btn-success">
                                <i class="fas fa-search me-2"></i>Detect Fields from Text
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Indicator -->
        <div id="processingIndicator" class="processing-indicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing...</span>
            </div>
            <h5 class="mt-3">Analyzing document and detecting fields...</h5>
            <p class="text-muted">This may take a few seconds</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <!-- Document Analysis Summary -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3 id="totalFields">0</h3>
                        <p>Fields Detected</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3 id="documentType">-</h3>
                        <p>Document Type</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3 id="processingTime">0ms</h3>
                        <p>Processing Time</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3 id="avgConfidence">0%</h3>
                        <p>Avg Confidence</p>
                    </div>
                </div>
            </div>

            <!-- Field Categories -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-tags me-2"></i>Detected Fields by Category
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="fieldsByCategory">
                                <!-- Categories will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Fields List -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>All Detected Fields
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="allFieldsList">
                                <!-- All fields will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OCR Text Display -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-dark text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-eye me-2"></i>Extracted Text
                            </h5>
                        </div>
                        <div class="card-body">
                            <pre id="extractedText" class="bg-light p-3 rounded" style="white-space: pre-wrap;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentResults = null;

        // DOM elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const textInput = document.getElementById('textInput');
        const confidenceSlider = document.getElementById('confidenceSlider');
        const confidenceValue = document.getElementById('confidenceValue');
        const detectFromTextBtn = document.getElementById('detectFromTextBtn');
        const processingIndicator = document.getElementById('processingIndicator');
        const resultsSection = document.getElementById('resultsSection');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateConfidenceDisplay();
        });

        function setupEventListeners() {
            // File upload
            uploadZone.addEventListener('click', () => fileInput.click());
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleFileDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            // Text detection
            detectFromTextBtn.addEventListener('click', detectFieldsFromText);
            
            // Confidence slider
            confidenceSlider.addEventListener('input', updateConfidenceDisplay);
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        function handleFileUpload(file) {
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('confidence_threshold', confidenceSlider.value);

            showProcessing();

            fetch('/api/fields/detect-from-image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideProcessing();
                if (data.success) {
                    displayResults(data);
                    if (data.extracted_text) {
                        textInput.value = data.extracted_text;
                    }
                } else {
                    showError('Field detection failed: ' + data.error);
                }
            })
            .catch(error => {
                hideProcessing();
                showError('Error: ' + error.message);
            });
        }

        function detectFieldsFromText() {
            const text = textInput.value.trim();
            if (!text) {
                showError('Please enter some text for field detection');
                return;
            }

            showProcessing();

            fetch('/api/fields/detect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    confidence_threshold: parseFloat(confidenceSlider.value)
                })
            })
            .then(response => response.json())
            .then(data => {
                hideProcessing();
                if (data.success) {
                    displayResults(data);
                } else {
                    showError('Field detection failed: ' + data.error);
                }
            })
            .catch(error => {
                hideProcessing();
                showError('Error: ' + error.message);
            });
        }

        function displayResults(data) {
            currentResults = data;
            
            // Update statistics
            document.getElementById('totalFields').textContent = data.total_fields_detected || 0;
            document.getElementById('documentType').textContent = data.document_type || 'Unknown';
            document.getElementById('processingTime').textContent = 
                ((data.processing_time || 0) * 1000).toFixed(0) + 'ms';
            
            // Calculate average confidence
            const avgConf = data.fields && data.fields.length > 0 
                ? (data.fields.reduce((sum, f) => sum + f.confidence, 0) / data.fields.length * 100).toFixed(0) + '%'
                : '0%';
            document.getElementById('avgConfidence').textContent = avgConf;
            
            // Display fields by category
            displayFieldsByCategory(data.categories || {});
            
            // Display all fields
            displayAllFields(data.fields || []);
            
            // Display extracted text if available
            if (data.extracted_text) {
                document.getElementById('extractedText').textContent = data.extracted_text;
            } else {
                document.getElementById('extractedText').textContent = textInput.value;
            }
            
            // Show results section
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayFieldsByCategory(categories) {
            const container = document.getElementById('fieldsByCategory');
            container.innerHTML = '';

            if (Object.keys(categories).length === 0) {
                container.innerHTML = '<p class="text-muted">No fields detected above the confidence threshold.</p>';
                return;
            }

            for (const [categoryName, fields] of Object.entries(categories)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-section';
                
                const categoryIcon = getCategoryIcon(categoryName);
                
                categoryDiv.innerHTML = `
                    <h6 class="text-primary">
                        <i class="${categoryIcon} me-2"></i>
                        ${categoryName.charAt(0).toUpperCase() + categoryName.slice(1)} Fields
                    </h6>
                    <div class="row">
                        ${fields.map(field => `
                            <div class="col-md-6 mb-2">
                                <div class="card field-card">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1">${field.field_name.replace('_', ' ')}</h6>
                                                <p class="card-text mb-2"><strong>${field.value}</strong></p>
                                            </div>
                                            <div class="text-end">
                                                <span class="confidence-badge ${getConfidenceClass(field.confidence)}">
                                                    ${(field.confidence * 100).toFixed(0)}%
                                                </span>
                                                <br>
                                                <span class="validation-status ${getValidationClass(field.validation_status)} mt-1">
                                                    ${field.validation_status}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(categoryDiv);
            }
        }

        function displayAllFields(fields) {
            const container = document.getElementById('allFieldsList');
            container.innerHTML = '';

            if (fields.length === 0) {
                container.innerHTML = '<p class="text-muted">No fields detected.</p>';
                return;
            }

            fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'card field-card mb-3';
                
                fieldDiv.innerHTML = `
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h6 class="mb-1">${field.field_name.replace('_', ' ')}</h6>
                                <small class="text-muted">${field.category_type}</small>
                            </div>
                            <div class="col-md-4">
                                <strong>${field.value}</strong>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="confidence-badge ${getConfidenceClass(field.confidence)}">
                                    ${(field.confidence * 100).toFixed(0)}%
                                </span>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="validation-status ${getValidationClass(field.validation_status)}">
                                    ${field.validation_status}
                                </span>
                            </div>
                            <div class="col-md-1 text-end">
                                <span class="method-badge ${getMethodClass(field.extraction_method)}">
                                    ${field.extraction_method.toUpperCase()}
                                </span>
                            </div>
                        </div>
                        ${field.context ? `
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted">Context: ${field.context}</small>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(fieldDiv);
            });
        }

        function getCategoryIcon(category) {
            const icons = {
                'personal': 'fas fa-user',
                'identification': 'fas fa-id-card',
                'contact': 'fas fa-phone',
                'address': 'fas fa-map-marker-alt',
                'financial': 'fas fa-credit-card',
                'general': 'fas fa-info-circle'
            };
            return icons[category] || 'fas fa-tag';
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 0.8) return 'confidence-high';
            if (confidence >= 0.6) return 'confidence-medium';
            return 'confidence-low';
        }

        function getValidationClass(status) {
            return `validation-${status}`;
        }

        function getMethodClass(method) {
            const methods = method.split('+');
            if (methods.length > 1) return 'method-hybrid';
            return `method-${method}`;
        }

        function updateConfidenceDisplay() {
            confidenceValue.textContent = confidenceSlider.value;
        }

        function showProcessing() {
            processingIndicator.style.display = 'block';
            resultsSection.style.display = 'none';
        }

        function hideProcessing() {
            processingIndicator.style.display = 'none';
        }

        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert after the input section
            const inputSection = document.querySelector('.row');
            inputSection.parentNode.insertBefore(alertDiv, inputSection.nextSibling);
        }
    </script>
</body>
</html>